<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>微信菜单配置</title>
    <style type="text/css">
        body {
            font-size: 14px;
            line-height: 1.6;
            font-family: "Helvetica Neue", "Hiragino Sans GB", "Microsoft YaHei", "\9ED1\4F53", Arial, sans-serif;
        }

        ul, ol {
            padding: 0;
            margin: 0;
            list-style-type: none;
        }

        a {
            color: #459ae9;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .tip {
            color: #8d8d8d;
        }

        #menu {
            width: 860px;
            position: relative;
        }

        #phone {
            width: 320px;
            border: 1px solid #dff3ff;
            background: #f0eff8;
            float: left;
            margin-right: 16px;
        }

        #phone-title {
            height: 64px;
            background: url("img/bg_mobile_head_default2968da.png");
        }

        #phone-title-text {
            text-align: center;
            padding-top: 24px;
            line-height: 40px;
            color: white;
        }

        #phone-content {
            height: 466px;
        }

        #phone-button {
            height: 50px;
            background: url("img/bg_mobile_foot_default2968da.png");
        }

        #phone-button-text {
            padding-left: 46px;
            line-height: 50px;
            position: relative;
        }

        #phone-button-text > ul {
            width: 100%;
            position: absolute;
        }

        #phone-button-text > ul > li {
            min-width: 91px;
            max-width: 137px;
            float: left;
            text-align: center;
            border-right: 1px solid #bcbbc4;
            cursor: pointer;
            position: relative;
        }

        #phone-button-text > ul > li > ul {
            width: 100%;
            position: absolute;
            bottom: 50px;
            border-bottom: 1px solid #bcbbc4;
            border-left: 1px solid #bcbbc4;
            background: white;
            left: -1px;
        }

        #phone-button-text > ul > li > ul > li {
            width: 100%;
            text-align: center;
            border-top: 1px solid #bcbbc4;
            border-right: 1px solid #bcbbc4;

        }

        #menu-edit {
            height: 575px;
            width: 530px;
            border: 1px solid silver;
            background: #F4F5F9;
            display: table-cell;
            float: none;
            padding: 0 20px 5px;

        }

        #menu-edit-title {
            padding: 9px;
            border-bottom: 1px solid silver;
        }

        #menu-edit-title-name {
            font-weight: bold;
            float: left;
        }

        #menu-edit-del {
            width: 100%;
            text-align: right;
        }

        .menu-type {
            overflow: hidden;
        }

        .menu-type li {
            float: left;
            padding: 5px;
            min-width: 50px;
            text-align: center;

        }

    </style>
    <script type="application/javascript" src="js/jquery-1.12.3.min.js"></script>

</head>
<body>
<div>
    <div>appID：<input type="text" id="appId" value="wx674e6fc604b987e6"></div>
    <div>appsecret：<input type="text" id="appsecret" value="e2b4eec5075464a31602ac035d686076"></div>
    <div><a href="javascript:void(0)" id="getAccessToken">获取accessToken</a></div>
</div>
<div>
    <input type="text" id="accessToken" value=""><a href="javascript:void(0)" id="querymeun">查询菜单</a>
</div>
<div id="menu">
    <div id="phone">
        <div id="phone-title">
            <div id="phone-title-text">微信公众号</div>
        </div>
        <div id="phone-content">

        </div>
        <div id="phone-button">
            <div id="phone-button-text">
                <ul id="phone-button-text-ul">
                    <!--<li>
                        <div id="m1" class="m" style="display: none"></div>
                        <ul  style="display: none">
                            <li id="m11" class="m" style="display: none"></li>
                            <li id="m12" class="m" style="display: none"></li>
                            <li id="m13" class="m" style="display: none"></li>
                            <li id="m14" class="m" style="display: none"></li>
                            <li id="m15" class="m" style="display: none"></li>
                        </ul>
                    </li>
                    <li>
                        <div id="m2" class="m" style="display: none"></div>
                        <ul  style="display: none">
                            <li id="m21" class="m" style="display: none"></li>
                            <li id="m22" class="m" style="display: none"></li>
                            <li id="m23" class="m" style="display: none"></li>
                            <li id="m24" class="m" style="display: none"></li>
                            <li id="m25" class="m" style="display: none"></li>
                        </ul>
                    </li>
                    <li>
                        <div id="m3" class="m" style="display: none"></div>
                        <ul  style="display: none">
                            <li id="m31" class="m" style="display: none"></li>
                            <li id="m32" class="m" style="display: none"></li>
                            <li id="m33" class="m" style="display: none"></li>
                            <li id="m34" class="m" style="display: none"></li>
                            <li id="m35" class="m" style="display: none"></li>
                        </ul>
                    </li>-->
                </ul>
            </div>
        </div>
    </div>
    <div id="menu-edit">
        <div id="menu-edit-tip" style="padding-top: 50px;">
            点击左侧编辑
        </div>
        <div id="menu-edit-content" style="display: none">
            <div id="menu-edit-title">
                <div id="menu-edit-title-name">编辑菜单</div>
                <div id="menu-edit-del"><a href="javascript:void(0)" id="menu-edit-del-a">删除菜单</a></div>
            </div>
            <div>
                菜单名称：<input type="text" id="menu-name">
                <p class="tip">字数不超过4个汉字或8个字母</p>
            </div>
            <div id="menu-type-vive">
                <!--            1、click：点击推事件用户点击click类型按钮后，微信服务器会通过消息接口推送消息类型为event的结构给开发者（参考消息接口指南），并且带上按钮中开发者填写的key值，开发者可以通过自定义的key值与用户进行交互；
                            2、view：跳转URL用户点击view类型按钮后，微信客户端将会打开开发者在按钮中填写的网页URL，可与网页授权获取用户基本信息接口结合，获得用户基本信息。
                            3、scancode_push：扫码推事件用户点击按钮后，微信客户端将调起扫一扫工具，完成扫码操作后显示扫描结果（如果是URL，将进入URL），且会将扫码的结果传给开发者，开发者可以下发消息。
                            4、scancode_waitmsg：扫码推事件且弹出“消息接收中”提示框用户点击按钮后，微信客户端将调起扫一扫工具，完成扫码操作后，将扫码的结果传给开发者，同时收起扫一扫工具，然后弹出“消息接收中”提示框，随后可能会收到开发者下发的消息。
                            5、pic_sysphoto：弹出系统拍照发图用户点击按钮后，微信客户端将调起系统相机，完成拍照操作后，会将拍摄的相片发送给开发者，并推送事件给开发者，同时收起系统相机，随后可能会收到开发者下发的消息。
                            6、pic_photo_or_album：弹出拍照或者相册发图用户点击按钮后，微信客户端将弹出选择器供用户选择“拍照”或者“从手机相册选择”。用户选择后即走其他两种流程。
                            7、pic_weixin：弹出微信相册发图器用户点击按钮后，微信客户端将调起微信相册，完成选择操作后，将选择的相片发送给开发者的服务器，并推送事件给开发者，同时收起相册，随后可能会收到开发者下发的消息。
                            8、location_select：弹出地理位置选择器用户点击按钮后，微信客户端将调起地理位置选择工具，完成选择操作后，将选择的地理位置发送给开发者的服务器，同时收起位置选择工具，随后可能会收到开发者下发的消息。
                            9、media_id：下发消息（除文本消息）用户点击media_id类型按钮后，微信服务器会将开发者填写的永久素材id对应的素材下发给用户，永久素材类型可以是图片、音频、视频、图文消息。请注意：永久素材id必须是在“素材管理/新增永久素材”接口上传后获得的合法id。
                            10、view_limited：跳转图文消息URL用户点击view_limited类型按钮后，微信客户端将打开开发者在按钮中填写的永久素材id对应的图文消息URL，永久素材类型只支持图文消息。请注意：永久素材id必须是在“素材管理/新增永久素材”接口上传后获得的合法id。-->
                菜单类型：
                <ul class="menu-type">
                    <li><input type="radio" id="click" name="type" value="click"> <label for="click">发送消息</label></li>
                    <li><input type="radio" id="view" name="type" value="view"> <label for="view">跳转网页</label></li>
                    <li><input type="radio" id="scancode_push" name="type" value="scancode_push"> <label
                            for="scancode_push">扫码推事件</label>
                    </li>
                    <li><input type="radio" id="scancode_waitmsg" name="type" value="scancode_waitmsg"> <label
                            for="scancode_waitmsg">扫码推事件且弹出“消息接收中”提示框</label></li>
                    <li><input type="radio" id="pic_sysphoto" name="type" value="pic_sysphoto"> <label
                            for="pic_sysphoto">拍照发图</label></li>
                    <li><input type="radio" id="pic_photo_or_album" name="type" value="pic_photo_or_album"> <label
                            for="pic_photo_or_album">发图</label></li>

                    <li><input type="radio" id="location_select" name="type" value="location_select"> <label
                            for="location_select">地理位置</label>
                    </li>
                    <li><input type="radio" id="media_id" name="type" value="media_id"> <label
                            for="media_id">图文消息</label>
                    </li>
                    <li><input type="radio" id="view_limited" name="type" value="view_limited"> <label
                            for="view_limited">跳转图文</label></li>
                </ul>
            </div>
            <div id="menu-type-content" style="padding-top: 20px">
                <div id="view-content" style="display: none">
                    跳转地址：<br/><input type="text" id="url">
                </div>
                <div id="key-content" style="display: none">
                    事件key:<br/><input type="text" id="key">
                </div>
            </div>
        </div>
    </div>
    <div style="clear: both">
        <a href="javascript:void(0)" id="menu-save">保存菜单</a>
    </div>
</div>
</body>
<script type="application/javascript">


    function baseSuccess(data) {
        console.log(data);
        if (data.errcode != null && data.errcode != 0) {
            alert("错误码：" + data.errcode + "\n" + "错误内容：" + data.errmsg)
            return false;
        }
        return true;
    }

    function myAjax(data, success) {
        $.ajax({
            url: "http://999.xutil.sinaapp.com/http.php",
            type: "get",
            dataType: "jsonp",
            data: data,
            success: function (data) {
                if (baseSuccess(data)) {
                    success(data);
                }
            }
        })

    }

    $("#getAccessToken").click(function () {
        var data = {
            url: "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=" + $("#appId").val() + "&secret=" + $("#appsecret").val(),
            type: "get",
        }
        myAjax(data, function (data) {
            window.localStorage.accessToken = data.access_token;
            $("#accessToken").val(data.access_token);
        });
    })


    $("#querymeun").click(function () {
        window.localStorage.accessToken = $("#accessToken").val();
        var data = {
            url: "https://api.weixin.qq.com/cgi-bin/menu/get?access_token=" + window.localStorage.accessToken,
            type: "get",
        }
        myAjax(data, function (data) {
            var ul = $("#phone-button-text-ul");
            ul.empty();
            var buttons = data.menu.button;
            var i = 0;
            if (buttons != null && buttons.length > 0) {
                for (; i < buttons.length; i++) {
                    var button = buttons[i];
                    var li = $("<li>");
                    var div = $("<div>");
                    div.text(button.name);
                    var button2 = button;
                    var subButtons = button.sub_button;
                    delete button2.sub_button;
                    div.data("data", button2);
                    div.attr("p", true);
                    li.append(div);


                    var j = 0;
                    var cul = $("<ul>");
                    cul.css({display: "none"});
                    if (subButtons != null && subButtons.length > 0) {
                        for (; j < subButtons.length; j++) {
                            var subButton = subButtons[j];
                            var cli = $("<li>");
                            var cdiv = $("<div>");
                            cdiv.attr("p", false);
                            cdiv.text(subButton.name);
                            var subButton2 = subButton;
                            delete subButton2.sub_button;
                            cdiv.data("data", subButton2);
                            cli.append(cdiv)
                            cul.append(cli);
                        }
                    }
                    if (j < 5) {
                        var cli = $("<li>");
                        var cdiv = $("<div>");
                        cdiv.text("+");
                        cdiv.attr("p", false);
                        cdiv.attr("n", true);
                        cli.append(cdiv);
                        //cli.data("data",subButton);
                        cul.append(cli);
                    }


                    li.append(cul);
                    ul.append(li);
                    /* var button = buttons[i];
                     var m = $("#m" + (i + 1));
                     m.text(button.name);
                     m.data("data",button);
                     m.css({display:"block"})
                     var subButtons = button.sub_button;
                     var j = 0;
                     if (subButtons != null && subButtons.length > 0) {
                     for (; j < subButtons.length; j++) {
                     var subButton=subButtons[j];
                     var mj=$("#m" + (i + 1)+(j+1));
                     mj.css({display:"block"})
                     mj.text(subButton.name);
                     mj.data("data",subButton);
                     }
                     }*/
                }
            }
            if (i < 3) {
                var li = $("<li>");
                var div = $("<div>");
                div.text("+");
                div.attr("p", true);
                div.attr("n", true);
                li.append(div);
                ul.append(li);
            }

            //ul.find(">li").eq(0).find(">div").click();

        });
    })


    //初始化
    $("#accessToken").val(window.localStorage.accessToken);
    if ($("#accessToken").val().length > 0) {
        $("#querymeun").click();
    }


    $("#phone-button-text-ul").delegate(">li>div", "click", function () {
        var div = $(this);
        var p = div.attr("p")
        div.parent().parent().find(">li>ul").css({display: "none"});

        var data = div.data("data")

        div.parent().find(">ul").css({display: "block"});

        mclick(div);


        /* menu-type-vive
         menu-type-content*/

    });


    $("#phone-button-text>ul").delegate(">li>ul>li>div", "click", function () {
        mclick($(this));
    })


    function mclick(tag) {
        $("#menu-edit-tip").css({display: "none"});
        $("#menu-edit-content").css({display: "block"});
        $("#phone-button-text-ul").find("div").css({background: "#FFFFFF"});
        /*$("#phone-button-text-ul").find("div").each(function(){
         $(this)
         })*/
        tag.css({background: "#D4F2F7"});
        /*if(tag.attr("p")==true){
         tag.parent().css({background:"#D4F2F7"});
         }else {

         }*/
        var data = tag.data("data");
        console.log(data);
        if (data == null) {
            tag.text("菜单名称");
            data = {
                "type": "view",
                "name": "菜单名称",
                "url": "http://"
            };
            tag.data("data", data);
            tag.attr("n", true);
            if (tag.attr("p") == "true") {
                var cul = $("<ul>");
                var cli = $("<li>");
                var cdiv = $("<div>");
                cdiv.text("+");
                cdiv.attr("p", false);
                //cli.data("data",subButton);
                cli.append(cdiv);
                cul.append(cli);
                tag.parent().append(cul);

                var pul = tag.parent().parent();

                if (pul.find(">li").length < 3) {
                    var li = $("<li>");
                    var div = $("<div>");
                    div.text("+");
                    div.attr("p", true);
                    div.attr("n", true);
                    li.append(div);
                    li.append(cul);
                    pul.append(li);
                }
            } else {
                var pul = tag.parent().parent();
                if (pul.find(">li").length == 1) {
                    var div = pul.parent().find(">div");
                    var data = div.data("data");
                    delete data.type;
                    div.data("data", data);
                }
                if (pul.find(">li").length < 5) {
                    var cli = $("<li>");
                    var cdiv = $("<div>");
                    cdiv.text("+");
                    cdiv.attr("p", false);
                    cdiv.attr("n", true);
                    cli.append(cdiv);
                    pul.append(cli);
                }
            }
        }

        var menuEditData = $("#menu-edit").data("data");
        if (menuEditData != null) {
            var odata = {};
            odata.name = $("#menu-name").val();
            odata.type = $("input[name='type']:checked").val();
            if (menuEditData.attr("p") == "true") {
                var pul = menuEditData.parent().find(">ul");
                if (pul.find(">li").length > 1) {
                    delete odata.type;
                }
            }

            if (odata.type == "view") {
                odata.url = $("#url").val();
                delete odata.key;
            } else {
                odata.key = $("#key").val();
                delete odata.url;
            }
            menuEditData.data("data", odata);

        }

        $("#menu-edit").data("data", tag);

        data = tag.data("data");
        $("#menu-name").val(data.name);
        $("input[name='type']").prop("checked", false);
        $("#view-content").css({display: "none"});
        $("#key-content").css({display: "none"});
        if (data.type != null) {
            $("#" + data.type).prop("checked", true);
            $("#menu-type-vive").css({display: "block"})

            /*
             <div id="view-content">
             <input type="text" id="url">
             </div>
             <div id="key-content">
             <input type="text" id="key">
             </div>*/
            if (data.type == "view") {
                $("#view-content").css({display: "block"});
                $("#url").val(data.url);
                $("#key").val("");
            } else {
                $("#key-content").css({display: "block"});
                $("#key").val(data.key);
                $("#url").val("");
            }


        } else {
            $("#menu-type-vive").css({display: "none"})
        }
    }
    $("#menu-edit-del-a").click(function () {
        var tag = $("#menu-edit").data("data");

        var ptag = tag.parent().parent();
        tag.parent().remove();
        if (tag.attr("p") == "true") {

            if (ptag.find(">li").length + 1 == 3) {
                var li = $("<li>");
                var div = $("<div>");
                div.text("+");
                div.attr("p", true);
                div.attr("n", true);
                li.append(div);
                ptag.append(li);
            }
        } else {

            if (ptag.find(">li").length + 1 == 5) {
                var cli = $("<li>");
                cli.text("+");
                cli.attr("p", false);
                cli.attr("n", true);
                //cli.data("data",subButton);
                tag.append(cli);
            }
            if (ptag.find(">li").length == 1) {
                var div = ptag.parent().find(">div");
                var data = div.data("data");
                data.type = "view";
                div.data("data", data);
            }
        }
        $("#menu-edit-tip").css({display: "block"});
        $("#menu-edit-content").css({display: "none"});
        // $("#phone-button-text-ul").find(">li").eq(0).find(">div").click();
    });

    $("#menu-save").click(function () {
        //$("#phone-button-text-ul").find(">li").eq(0).find(">div").click();
        $("#phone-button-text-ul").find("div").css({background: "#FFFFFF"});
        $("#phone-button-text-ul").find(">li>ul").css({display: "none"});

        $("#menu-edit-tip").css({display: "block"});
        $("#menu-edit-content").css({display: "none"});
        var meun = {button: []};
        var lis = $("#phone-button-text-ul").find(">li");
        for (var i = 0; i < lis.length; i++) {
            var li = lis.eq(i);
            var div = li.find(">div");
            var data = div.data("data");
            if (data != null) {

                var cdivs = li.find(">ul>li>div");
                if (cdivs != null && cdivs.length > 0) {
                    data.sub_button = [];
                    for (var j = 0; j < cdivs.length; j++) {
                        var cdiv = cdivs.eq(j);
                        var cdata = cdiv.data("data");
                        if (cdata != null) {
                            data.sub_button[j] = cdata;
                        }
                    }
                }
                meun.button[i] = data;
            }
        }
        console.log(meun);
        console.log(JSON.stringify(meun));
        var jdata = {
            url: "https://api.weixin.qq.com/cgi-bin/menu/create?access_token=" + window.localStorage.accessToken,
            type: "post",
            data: JSON.stringify(meun)
        }
        myAjax(jdata, function (data) {
            alert("保存成功")
        })
    });

    $("input[name='type']").click(function () {
        $("#view-content").css({display: "none"});
        $("#key-content").css({display: "none"});
        if ($(this).val() == "view") {
            $("#view-content").css({display: "block"});
        } else {
            $("#key-content").css({display: "block"});
        }
    })
</script>
</html>